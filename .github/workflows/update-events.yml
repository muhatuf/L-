name: Update Le Havre Events

on:
  schedule:
    - cron: '0 6 * * 0'  # Runs every Sunday at 6 AM
  workflow_dispatch:  # Allows manual triggering
  push:
    branches: [ master ]  # Changed from 'main' to 'master'
    paths:
      - 'scraper.py'
      - '.github/workflows/update-events.yml'

jobs:
  update-events:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing changes
    
    steps:
    # Existing setup steps remain the same until the commit/push section...

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # Verify we're on the correct branch
        CURRENT_BRANCH=$(git branch --show-current)
        if [ "$CURRENT_BRANCH" != "master" ]; then
          echo "Error: Expected to be on 'master' branch but found '$CURRENT_BRANCH'"
          exit 1
        fi

        # Configure git
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"

        # Add and commit changes
        git add lehavre_events_test.json
        if [ -f "lehavre_events_test_with_metadata.json" ]; then
          git add lehavre_events_test_with_metadata.json
        fi

        git commit -m "Automated event data update [skip ci]" || echo "No changes to commit"

        # Push changes
        echo "Pushing to master branch..."
        git pull --rebase origin master
        git push origin master
